<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Excel to Mindmap Converter - Free Interactive Data Visualization</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Free online tool to convert Excel files into interactive mindmaps. Visualize data with country comparisons, search functionality, and beautiful D3.js graphics.">
    <meta name="keywords" content="excel, mindmap, data visualization, converter, free tool, interactive, d3js, banking functions">
    <meta name="author" content="Excel to Mindmap Converter">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://serenaplin-jpg.github.io/sheet-2-mindmap/">
    <meta property="og:title" content="Excel to Mindmap Converter">
    <meta property="og:description" content="Convert Excel files to interactive mindmaps with country comparisons and search functionality">
    <meta property="og:image" content="https://serenaplin-jpg.github.io/sheet-2-mindmap/assets/preview.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://serenaplin-jpg.github.io/sheet-2-mindmap/">
    <meta property="twitter:title" content="Excel to Mindmap Converter">
    <meta property="twitter:description" content="Convert Excel files to interactive mindmaps with country comparisons and search functionality">
    <meta property="twitter:image" content="https://serenaplin-jpg.github.io/sheet-2-mindmap/assets/preview.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧠</text></svg>">
    
    <!-- External Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overflow: hidden;
        }
        .node circle {
            cursor: pointer;
            stroke-width: 2.5px;
        }
        .node text {
            font-size: 14px;
            paint-order: stroke;
            stroke: #fff;
            stroke-width: 3.5px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: #cbd5e1;
            stroke-width: 1.5px;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7rem center;
            background-size: .65em auto;
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .file-upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .dataset-card {
            transition: all 0.2s ease;
        }
        .dataset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div id="root"></div>

    <script type="text/babel" data-cache-buster="v1.0.1">
        const { useState, useEffect, useRef, useCallback } = React;

        // URL Routing - Get initial view from URL hash
        const getInitialView = () => {
            // Use hash routing as primary method
            const hash = window.location.hash.replace('#', '');
            if (hash && hash !== '') {
                switch (hash) {
                    case 'upload': return 'upload';
                    case 'saved': return 'saved';
                    case 'table': return 'table';
                    case 'mindmap': return 'mindmap';
                    default: return 'home';
                }
            }
            
            // Fallback to path-based routing for legacy URLs
            const path = window.location.pathname.replace('/sheet-2-mindmap', '').replace(/^\/+|\/+$/g, '');
            if (path && path !== '') {
                switch (path) {
                    case 'upload': return 'upload';
                    case 'saved': return 'saved';
                    case 'table': return 'table';
                    case 'mindmap': return 'mindmap';
                    default: return 'home';
                }
            }
            
            return 'home';
        };

        // Built-in datasets configuration
        const BUILTIN_DATASETS = [];

        // Get saved datasets from localStorage






        // Excel parser utility
        const parseExcelToMindmap = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Transform Excel data to mindmap format
                        const mindmapData = transformToMindmapFormat(jsonData);
                        resolve(mindmapData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        };

        // Transform Excel data to mindmap format
        const transformToMindmapFormat = (data) => {
            if (data.length < 2) {
                throw new Error('Excel file must have at least 2 rows (header + data)');
            }

            const headers = data[0];
            
            // Find name column - support multiple formats
            let nameIndex = headers.findIndex(h => h && (
                h.toString().toLowerCase().includes('name') ||
                h.toString().includes('功能名稱') ||
                h.toString().includes('Function Name')
            ));
            
            // Find category column - support multiple formats
            let categoryIndex = headers.findIndex(h => h && (
                h.toString().toLowerCase().includes('category') ||
                h.toString().includes('大項') ||
                h.toString().includes('Category')
            ));
            
            if (nameIndex === -1) {
                // If no specific name column found, try to find the most likely candidate
                nameIndex = headers.findIndex(h => h && h.toString().trim() !== '' && !h.toString().includes('('));
                if (nameIndex === -1) {
                    throw new Error('Excel file must have a column containing function names');
                }
            }

            // Get country columns (exclude name, category, sub-item, platform columns)
            const excludePatterns = ['name', 'category', '大項', '細項', 'sub-item', 'platform', '平台', '功能名稱'];
            const countryColumns = headers
                .map((header, index) => ({ header: header?.toString() || `Column${index}`, index }))
                .filter(col => {
                    const headerLower = col.header.toLowerCase();
                    const isExcluded = excludePatterns.some(pattern => 
                        headerLower.includes(pattern.toLowerCase()) || 
                        col.header.includes(pattern)
                    );
                    return !isExcluded && 
                           col.index !== nameIndex && 
                           col.index !== categoryIndex && 
                           col.header.trim() !== '';
                })
                .slice(0, 15); // Support up to 15 countries

            const countries = countryColumns.map(col => {
                // Clean up country names - extract main name from bilingual format
                let countryName = col.header;
                const parenIndex = countryName.indexOf('(');
                if (parenIndex > 0) {
                    countryName = countryName.substring(0, parenIndex).trim();
                }
                return countryName;
            });
            
            // Group data by category if category column exists
            const categories = new Map();
            let currentCategory = null;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[nameIndex] || row[nameIndex].toString().trim() === '') continue;
                
                const name = row[nameIndex].toString().trim();
                let category = null;
                
                if (categoryIndex !== -1 && row[categoryIndex] && row[categoryIndex].toString().trim() !== '') {
                    // This row has a category - use it and remember it for subsequent rows
                    category = row[categoryIndex].toString().trim();
                    // Clean up category name - extract main name from bilingual format
                    const parenIndex = category.indexOf('(');
                    if (parenIndex > 0) {
                        category = category.substring(0, parenIndex).trim();
                    }
                    currentCategory = category;
                } else if (currentCategory) {
                    // This row has no category - use the last seen category
                    category = currentCategory;
                } else {
                    // No category at all, skip this row
                    continue;
                }
                
                if (!categories.has(category)) {
                    categories.set(category, []);
                }
                
                // Build availability object
                const availability = {};
                countryColumns.forEach((col, index) => {
                    const value = row[col.index];
                    const countryName = countries[index];
                    availability[countryName] = value && (
                        value.toString() === 'V' ||
                        value.toString() === 'v' ||
                        value.toString() === '√' ||
                        value.toString().toLowerCase() === 'yes' ||
                        value.toString().toLowerCase() === 'true' ||
                        value.toString() === '1'
                    ) ? 'V' : 'X';
                });
                
                categories.get(category).push({
                    name,
                    availability
                });
            }
            
            // Convert to mindmap format
            const children = Array.from(categories.entries())
                .filter(([categoryName, items]) => items.length > 0)
                .map(([categoryName, items]) => ({
                    name: categoryName,
                    children: items
                }));
            
            return {
                data: {
                    name: "Functions Mindmap",
                    children
                },
                countries
            };
        };

        // D3 Mindmap Component
        const D3Mindmap = React.forwardRef(({ data, countries, selectedCountries, searchTerm, onStatsUpdate }, ref) => {
            const svgRef = useRef();
            const containerRef = useRef();
            
            // Create imperative handle for ref methods
            React.useImperativeHandle(ref, () => ({
                expandAll: () => {
                    if (containerRef.current && containerRef.current.expandAllInternal) {
                        containerRef.current.expandAllInternal();
                    }
                },
                collapseAll: () => {
                    if (containerRef.current && containerRef.current.collapseAllInternal) {
                        containerRef.current.collapseAllInternal();
                    }
                },
                centerView: () => {
                    if (containerRef.current && containerRef.current.centerViewInternal) {
                        containerRef.current.centerViewInternal();
                    }
                }
            }), []);
            
            useEffect(() => {
                if (!data || !countries.length) return;
                
                const container = containerRef.current;
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                // Clear previous content
                d3.select(svgRef.current).selectAll("*").remove();
                
                let i = 0;
                
                const zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
                
                const svg = d3.select(svgRef.current)
                    .attr("width", width)
                    .attr("height", height)
                    .call(zoom);
                
                const g = svg.append("g");
                const tree = d3.tree().nodeSize([50, 300]);
                const root = d3.hierarchy(data);
                
                root.x0 = height / 2;
                root.y0 = 0;
                root.descendants().forEach((d, i) => {
                    d.id = i;
                    d._children = d.children;
                    if (d.depth > 0) d.children = null;
                });
                
                const getNodeColor = (d, countryA, countryB) => {
                    if (!d.data.availability) {
                        return d._children ? "#a5b4fc" : "#e2e8f0";
                    }
                    const availA = d.data.availability[countryA] === 'V';
                    const availB = d.data.availability[countryB] === 'V';
                    if (availA && availB) return "#4ade80";
                    if (availA) return "#60a5fa";
                    if (availB) return "#fb923c";
                    return "#e5e7eb";
                };
                
                const update = (source, countryA, countryB, centerNode = null) => {
                    const duration = 250;
                    const nodes = root.descendants().reverse();
                    const links = root.links();
                    
                    tree(root);
                    
                    const node = g.selectAll("g.node").data(nodes, d => d.id);
                    
                    const nodeEnter = node.enter().append("g")
                        .attr("class", "node")
                        .attr("transform", `translate(${source.y0},${source.x0})`)
                        .attr("fill-opacity", 0)
                        .attr("stroke-opacity", 0)
                        .on("click", (event, d) => {
                            if (d.depth === 0) return;
                            d.children = d.children ? null : d._children;
                            update(d, countryA, countryB);
                        });
                    
                    nodeEnter.append("circle")
                        .attr("r", 10)
                        .attr("stroke", d => d.data.availability ? "#9ca3af" : "#6366f1");
                    
                    nodeEnter.append("text")
                        .attr("x", d => d._children || d.children ? -18 : 18)
                        .attr("dy", "0.31em")
                        .attr("text-anchor", d => d._children || d.children ? "end" : "start")
                        .text(d => d.data.name)
                        .style("fill", "#1f2937")
                        .clone(true).lower()
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-width", 3)
                        .attr("stroke", "white");
                    
                    const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
                        .attr("transform", d => `translate(${d.y},${d.x})`)
                        .attr("fill-opacity", 1)
                        .attr("stroke-opacity", 1);
                    
                    nodeUpdate.select('circle')
                        .attr("fill", d => getNodeColor(d, countryA, countryB));
                    
                    node.exit().transition().duration(duration).remove()
                        .attr("transform", `translate(${source.y},${source.x})`)
                        .attr("fill-opacity", 0)
                        .attr("stroke-opacity", 0);
                    
                    const link = g.selectAll("path.link").data(links, d => d.target.id);
                    
                    const linkEnter = link.enter().insert("path", "g")
                        .attr("class", "link")
                        .attr("d", d3.linkHorizontal().x(d => source.y0).y(d => source.x0));
                    
                    link.merge(linkEnter).transition().duration(duration)
                        .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));
                    
                    link.exit().transition().duration(duration).remove()
                        .attr("d", d3.linkHorizontal().x(d => source.y).y(d => source.x));
                    
                    root.each(d => {
                        d.x0 = d.x;
                        d.y0 = d.y;
                    });
                    
                    // Handle search highlighting
                    if (centerNode) {
                        setTimeout(() => {
                            const scale = 1;
                            const x = -centerNode.y * scale + width / 2;
                            const y = -centerNode.x * scale + height / 2;
                            
                            const transform = d3.zoomIdentity.translate(x, y).scale(scale);
                            svg.transition().duration(750).call(zoom.transform, transform);
                            
                            g.selectAll(".node")
                                .filter(d => d.id === centerNode.id)
                                .select("circle")
                                .transition().duration(250)
                                .attr("r", 15)
                                .style("stroke", "#ef4444")
                                .transition().duration(750)
                                .attr("r", 10)
                                .style("stroke", d => d.data.availability ? "#9ca3af" : "#6366f1");
                        }, duration);
                    }
                    
                    // Calculate and update stats
                    if (onStatsUpdate) {
                        let total = 0, countA = 0, countB = 0;
                        root.each(d => {
                            if (d.data.availability) {
                                total++;
                                if (d.data.availability[countryA] === 'V') countA++;
                                if (d.data.availability[countryB] === 'V') countB++;
                            }
                        });
                        onStatsUpdate({ total, countA, countB, countryA, countryB });
                    }
                };
                
                // Handle search
                if (searchTerm) {
                    let targetNode = null;
                    root.each(d => {
                        if (d.data.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            targetNode = d;
                        }
                    });
                    
                    if (targetNode) {
                        let current = targetNode.parent;
                        while(current) {
                            if(current._children) {
                                current.children = current._children;
                            }
                            current = current.parent;
                        }
                        update(root, selectedCountries[0], selectedCountries[1], targetNode);
                    }
                } else {
                    update(root, selectedCountries[0], selectedCountries[1]);
                }
                
                // Center view initially
                const initialTransform = d3.zoomIdentity.translate(width / 4, height / 2).scale(1);
                svg.call(zoom.transform, initialTransform);
                
                // Expose utility functions to container
                containerRef.current.expandAllInternal = () => {
                    root.each(d => {
                        if (d._children) {
                            d.children = d._children;
                            d._children = null;
                        }
                    });
                    update(root, selectedCountries[0], selectedCountries[1]);
                };
                
                containerRef.current.collapseAllInternal = () => {
                    root.each(d => {
                        if (d.depth > 0) {
                            if (d.children) {
                                d._children = d.children;
                                d.children = null;
                            }
                        }
                    });
                    update(root, selectedCountries[0], selectedCountries[1]);
                };
                
                containerRef.current.centerViewInternal = () => {
                    svg.transition().duration(750).call(zoom.transform, initialTransform);
                };
                
            }, [data, countries, selectedCountries, searchTerm]);
            
            return (
                <div ref={containerRef} className="w-full h-screen">
                    <svg ref={svgRef}></svg>
                </div>
            );
        });

        // Main App Component
        const App = () => {
            const [rawData, setRawData] = useState(null);
            const [editableData, setEditableData] = useState(null);
            const [mindmapData, setMindmapData] = useState(null);
            const [countries, setCountries] = useState([]);
            const [selectedCountries, setSelectedCountries] = useState(['', '']);
            const [searchTerm, setSearchTerm] = useState('');
            const [stats, setStats] = useState({ total: 0, countA: 0, countB: 0, countryA: '', countryB: '' });
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [searchShake, setSearchShake] = useState(false);
            
            const [currentView, setCurrentView] = useState(() => {
                // Initialize with proper route detection
                return getInitialView();
            });
            const [savedDatasets, setSavedDatasets] = useState([]);
            
            // Navigation function that updates both state and URL hash
            const navigateTo = (view) => {
                setCurrentView(view);
                // Use hash-based routing
                const newHash = view === 'home' ? '' : view;
                
                if (window.location.hash.replace('#', '') !== newHash) {
                    if (newHash === '') {
                        // For home, clear the hash
                        window.history.pushState({}, '', window.location.pathname);
                    } else {
                        // For other views, set the hash
                        window.history.pushState({}, '', `${window.location.pathname}#${newHash}`);
                    }
                }
            };
            
            // Handle browser back/forward buttons and hash changes
            useEffect(() => {
                const handleNavigation = () => {
                    const newView = getInitialView();
                    if (newView !== currentView) {
                        setCurrentView(newView);
                    }
                };
                
                // Listen to both popstate and hashchange events
                window.addEventListener('popstate', handleNavigation);
                window.addEventListener('hashchange', handleNavigation);
                
                return () => {
                    window.removeEventListener('popstate', handleNavigation);
                    window.removeEventListener('hashchange', handleNavigation);
                };
            }, [currentView]);
            
            // Load datasets from GitHub when component mounts
            useEffect(() => {
                // Only load if we don't already have datasets
                if (savedDatasets.length === 0) {
                    loadDatasetsFromGitHub();
                }
            }, []);
            
            const [githubToken, setGithubToken] = useState(localStorage.getItem('github_token') || '');
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            const [currentDatasetId, setCurrentDatasetId] = useState(null);
            const [showSaveDialog, setShowSaveDialog] = useState(false);
            const [customDatasetName, setCustomDatasetName] = useState('');
            const mindmapRef = useRef();
            
            const handleFileUpload = async (file) => {
                if (!file) return;
                
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    setError('Please upload an Excel file (.xlsx or .xls)');
                    return;
                }
                
                setIsLoading(true);
                setError('');
                
                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            setRawData(jsonData);
                            setEditableData(JSON.parse(JSON.stringify(jsonData))); // Deep copy
                            
                            // Ask if user wants to save this dataset
                            const shouldSave = confirm(`Would you like to save "${file.name}" for future use?`);
                            if (shouldSave) {
                                const savedDataset = saveUploadedDataset(jsonData, file.name);
                                if (savedDataset) {
                                    setCurrentDatasetId(savedDataset.id);
                                    // Add to savedDatasets immediately
                                    setSavedDatasets(prev => [...prev, savedDataset]);
                                }
                            } else {
                                // Create a temporary dataset ID for unsaved uploads
                                setCurrentDatasetId(`temp_${Date.now()}`);
                            }
                            
                            navigateTo('table');
                            setIsLoading(false);
                        } catch (error) {
                            setError(error.message || 'Failed to parse Excel file');
                            setIsLoading(false);
                        }
                    };
                    reader.onerror = () => {
                        setError('Failed to read file');
                        setIsLoading(false);
                    };
                    reader.readAsArrayBuffer(file);
                } catch (err) {
                    setError(err.message || 'Failed to parse Excel file');
                    setIsLoading(false);
                }
            };
            
            const saveUploadedDataset = (data, filename) => {
                const datasetId = `uploaded_${Date.now()}`;
                const name = filename.replace(/\.[^/.]+$/, ''); // Remove extension
                
                // Count functions and countries
                const functionCount = data.length - 1; // Exclude header
                const countries = [];
                if (data.length > 0) {
                    const headers = data[0];
                    const excludePatterns = ['name', 'category', '大項', '細項', 'sub-item', 'platform', '平台', '功能名稱'];
                    headers.forEach((header, index) => {
                        if (header) {
                            const headerLower = header.toLowerCase();
                            const isExcluded = excludePatterns.some(pattern => 
                                headerLower.includes(pattern.toLowerCase()) || 
                                header.includes(pattern)
                            );
                            if (!isExcluded && header.trim() !== '') {
                                let countryName = header;
                                const parenIndex = countryName.indexOf('(');
                                if (parenIndex > 0) {
                                    countryName = countryName.substring(0, parenIndex).trim();
                                }
                                countries.push(countryName);
                            }
                        }
                    });
                }
                
                const dataset = {
                    id: datasetId,
                    name: name,
                    description: `Uploaded dataset with ${functionCount} functions`,
                    countries: countries.slice(0, 10),
                    functions: functionCount,
                    data: data,
                    uploadDate: new Date().toISOString(),
                    isBuiltIn: false
                };
                
                return dataset;
            };
            
            const loadSavedDataset = async (dataset) => {
                setIsLoading(true);
                setError('');
                
                try {
                    if (dataset.data) {
                        // Dataset already has data loaded
                        setRawData(dataset.data);
                        setEditableData(JSON.parse(JSON.stringify(dataset.data)));
                        setCurrentDatasetId(dataset.id);
                        navigateTo('table');
                    } else if (dataset.downloadUrl) {
                        // This is a GitHub dataset, load it from the URL
                        // Force refresh with cache-busting
                        const cacheBuster = `v=${Date.now()}&r=${Math.random()}`;
                        const urlWithCacheBuster = `${dataset.downloadUrl}?${cacheBuster}`;
                        
                        const response = await fetch(urlWithCacheBuster, {
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to load dataset from GitHub');
                        }
                        
                        const data = await response.json();
                        setRawData(data);
                        setEditableData(JSON.parse(JSON.stringify(data)));
                        setCurrentDatasetId(dataset.id);
                        navigateTo('table');
                    } else {
                        setError('Dataset data not available');
                    }
                } catch (err) {
                    setError(`Failed to load dataset: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const loadSampleDataset = async (datasetUrl) => {
                setIsLoading(true);
                setError('');
                
                try {
                    // Add cache-busting parameter to always fetch fresh data
                    const cacheBuster = new Date().getTime();
                    const urlWithCacheBuster = `${datasetUrl}?v=${cacheBuster}`;
                    
                    const response = await fetch(urlWithCacheBuster, {
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load sample dataset');
                    }
                    const jsonData = await response.json();
                    
                    setRawData(jsonData);
                    setEditableData(JSON.parse(JSON.stringify(jsonData)));
                    
                    // Set current dataset ID for saving - use the actual dataset name
                    setCurrentDatasetId('github_gmb-banking-functions');
                    
                    navigateTo('table');
                } catch (err) {
                    setError('Sample dataset not available. Please upload your own Excel file.');
                } finally {
                    setIsLoading(false);
                }
            };
            
            const loadDatasetsFromGitHub = async () => {
                console.log('loadDatasetsFromGitHub called - discovering datasets');
                
                // Prevent multiple simultaneous calls
                if (isLoading) {
                    console.log('Already loading, skipping...');
                    return;
                }
                
                setIsLoading(true);
                setError('');
                
                try {
                    const knownDatasets = [];
                    
                    // Check if we have any datasets in localStorage (temporary storage for current session)
                    const sessionDatasets = JSON.parse(localStorage.getItem('session_datasets') || '[]');
                    if (sessionDatasets.length > 0) {
                        knownDatasets.push(...sessionDatasets);
                    }
                    
                    // Add any datasets that were created in this session
                    if (window.currentSessionDatasets) {
                        knownDatasets.push(...window.currentSessionDatasets);
                    }
                    
                    // Dynamically discover JSON files from GitHub repository
                    let dataFilesToCheck = [];
                    
                    try {
                        console.log('Fetching file list from GitHub API...');
                        // Use GitHub API to list files in the data directory
                        const repoApiUrl = 'https://api.github.com/repos/serenaplin-jpg/sheet-2-mindmap/contents/data';
                        const apiResponse = await fetch(repoApiUrl, {
                            cache: 'no-cache',
                            headers: {
                                'Accept': 'application/vnd.github.v3+json',
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'User-Agent': 'sheet-2-mindmap-app'
                            }
                        });
                        
                        if (apiResponse.ok) {
                            const files = await apiResponse.json();
                            // Filter for JSON files only
                            dataFilesToCheck = files
                                .filter(file => file.type === 'file' && file.name.endsWith('.json'))
                                .map(file => file.name)
                                .sort(); // Sort alphabetically
                            console.log('Discovered JSON files from GitHub:', dataFilesToCheck);
                        } else if (apiResponse.status === 403) {
                            // Handle rate limiting
                            const rateLimitReset = apiResponse.headers.get('X-RateLimit-Reset');
                            const resetTime = rateLimitReset ? new Date(parseInt(rateLimitReset) * 1000).toLocaleTimeString() : 'later';
                            throw new Error(`GitHub API rate limit exceeded. Try again at ${resetTime}`);
                        } else {
                            throw new Error(`GitHub API returned ${apiResponse.status}: ${apiResponse.statusText}`);
                        }
                    } catch (apiError) {
                        console.log('GitHub API failed, using fallback list:', apiError.message);
                        // Fallback to known files if GitHub API fails
                        dataFilesToCheck = [
                            'gmb-banking-functions.json',
                            'abc.json',
                            'abc1.json',
                            'abcd.json'
                        ];
                    }
                    
                    console.log('Final file list to check:', dataFilesToCheck);
                    
                    let foundFiles = 0;
                    for (const filename of dataFilesToCheck) {
                        try {
                            // Force refresh with multiple cache-busting parameters
                            const cacheBuster = `v=${Date.now()}&r=${Math.random()}&cb=${performance.now()}`;
                            console.log(`Attempting to load: ./data/${filename}`);
                            
                            const response = await fetch(`./data/${filename}?${cacheBuster}`, {
                                cache: 'no-cache',
                                headers: {
                                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                                    'Pragma': 'no-cache',
                                    'Expires': '0'
                                }
                            });
                            
                            console.log(`Response for ${filename}:`, response.status);
                            
                            if (response.ok) {
                                foundFiles++;
                                const jsonData = await response.json();
                                console.log(`Successfully loaded ${filename}:`, jsonData.length, 'rows');
                                
                                // Create dataset metadata
                                const name = filename.replace('.json', '').replace(/-/g, ' ')
                                    .replace(/\b\w/g, l => l.toUpperCase());
                                
                                // Count functions and extract countries
                                let functionCount = 0;
                                let countries = [];
                                
                                if (jsonData.length > 1) {
                                    functionCount = jsonData.length - 1; // Exclude header
                                    const headers = jsonData[0];
                                    const excludePatterns = ['name', 'category', '大項', '細項', 'sub-item', 'platform', '平台', '功能名稱'];
                                    
                                    countries = headers.filter((header, index) => {
                                        if (!header) return false;
                                        const headerLower = header.toLowerCase();
                                        const isExcluded = excludePatterns.some(pattern => 
                                            headerLower.includes(pattern.toLowerCase()) || 
                                            header.includes(pattern)
                                        );
                                        return !isExcluded && header.trim() !== '';
                                    }).map(header => {
                                        // Clean up country names
                                        const parenIndex = header.indexOf('(');
                                        return parenIndex > 0 ? header.substring(0, parenIndex).trim() : header;
                                    });
                                }
                                
                                const dataset = {
                                    id: `github_${filename.replace('.json', '')}`,
                                    name: name,
                                    description: `Dataset with ${functionCount} functions from GitHub repository`,
                                    countries: countries,
                                    functions: functionCount,
                                    data: jsonData, // Store the actual data instead of a URL
                                    isBuiltIn: false,
                                    githubUrl: `https://github.com/serenaplin-jpg/sheet-2-mindmap/blob/main/data/${filename}`,
                                    lastUpdated: Date.now() // Track when we last fetched this
                                };
                                
                                // Check if already exists in knownDatasets and update or add
                                const existingIndex = knownDatasets.findIndex(d => d.id === dataset.id);
                                if (existingIndex >= 0) {
                                    knownDatasets[existingIndex] = dataset; // Update existing
                                } else {
                                    knownDatasets.push(dataset); // Add new
                                }
                                console.log(`Added dataset: ${name} with ${functionCount} functions`);
                            }
                        } catch (fileErr) {
                            // Silently ignore files that don't exist
                            if (!fileErr.message.includes('404')) {
                                console.log(`Error loading ${filename}:`, fileErr.message);
                            }
                        }
                    }
                    
                    setSavedDatasets(knownDatasets);
                    console.log(`Total datasets found: ${knownDatasets.length} (${foundFiles} files loaded)`);
                    
                    // Show success message indicating source
                    if (dataFilesToCheck.length > 4) {
                        console.log('✅ Used GitHub API for dynamic file discovery');
                    } else {
                        console.log('⚠️ Used fallback file list (GitHub API unavailable)');
                    }
                    
                } catch (err) {
                    console.log('Error loading datasets:', err.message);
                    setError(`Failed to load datasets: ${err.message}. GitHub API may be unavailable.`);
                    setSavedDatasets([]);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const saveToGitHub = async () => {
                if (!githubToken) {
                    setError('Please provide a GitHub Personal Access Token to save changes.');
                    return;
                }
                
                if (!currentDatasetId) {
                    setError('Please load a dataset first before saving changes.');
                    return;
                }
                
                setIsSaving(true);
                setSaveMessage('');
                setError('');
                
                try {
                    // Determine the correct file path based on dataset ID
                    let filePath;
                    if (currentDatasetId === 'github_gmb-banking-functions') {
                        filePath = 'data/gmb-banking-functions.json';
                    } else if (currentDatasetId.startsWith('github_')) {
                        // Extract filename from github dataset ID
                        const filename = currentDatasetId.replace('github_', '') + '.json';
                        filePath = `data/${filename}`;
                    } else if (currentDatasetId.startsWith('uploaded_') || currentDatasetId.startsWith('temp_')) {
                        // For uploaded datasets, prompt to save as new
                        setError('This is an uploaded dataset. Use "Save as New Dataset" to save it to GitHub.');
                        return;
                    } else {
                        setError('This dataset cannot be saved to GitHub. Only GitHub-hosted datasets can be updated.');
                        return;
                    }
                    
                    // Get current file to get SHA
                    const getResponse = await fetch(`https://api.github.com/repos/serenaplin-jpg/sheet-2-mindmap/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                        },
                    });
                    
                    if (!getResponse.ok) {
                        throw new Error('Failed to get current file information');
                    }
                    
                    const fileInfo = await getResponse.json();
                    
                    // Prepare the updated content with proper UTF-8 encoding
                    const jsonString = JSON.stringify(editableData, null, 2);
                    const content = btoa(unescape(encodeURIComponent(jsonString)));
                    
                    // Update the file
                    const updateResponse = await fetch(`https://api.github.com/repos/serenaplin-jpg/sheet-2-mindmap/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: `Update ${filePath.split('/').pop().replace('.json', '').replace(/-/g, ' ')} data`,
                            content: content,
                            sha: fileInfo.sha,
                            branch: 'main'
                        }),
                    });
                    
                    if (!updateResponse.ok) {
                        const errorData = await updateResponse.json();
                        throw new Error(errorData.message || 'Failed to save to GitHub');
                    }
                    
                    setSaveMessage('✅ Successfully saved to GitHub! Changes will be live in a few minutes.');
                    
                    // Update raw data to match what we just saved
                    setRawData(JSON.parse(JSON.stringify(editableData)));
                    
                } catch (err) {
                    setError(`Failed to save to GitHub: ${err.message}`);
                } finally {
                    setIsSaving(false);
                }
            };
            
            const saveNewDatasetToGitHub = async (datasetName) => {
                if (!githubToken) {
                    setError('Please provide a GitHub Personal Access Token to save new datasets.');
                    return;
                }
                
                if (!datasetName || datasetName.trim() === '') {
                    setError('Please provide a name for your dataset.');
                    return;
                }
                
                setIsSaving(true);
                setSaveMessage('');
                setError('');
                
                try {
                    // Create a safe filename
                    const safeName = datasetName.trim()
                        .replace(/[^a-zA-Z0-9\s-_]/g, '') // Remove special characters
                        .replace(/\s+/g, '-') // Replace spaces with hyphens
                        .toLowerCase();
                    
                    const filePath = `data/${safeName}.json`;
                    
                    // Check if file already exists
                    const checkResponse = await fetch(`https://api.github.com/repos/serenaplin-jpg/sheet-2-mindmap/contents/${filePath}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                        },
                    });
                    
                    if (checkResponse.ok) {
                        setError(`A dataset with the name "${datasetName}" already exists. Please choose a different name.`);
                        setIsSaving(false);
                        return;
                    }
                    
                    // Prepare the content with proper UTF-8 encoding
                    const jsonString = JSON.stringify(editableData, null, 2);
                    const content = btoa(unescape(encodeURIComponent(jsonString)));
                    
                    // Create the new file
                    const createResponse = await fetch(`https://api.github.com/repos/serenaplin-jpg/sheet-2-mindmap/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: `Add new dataset: ${datasetName}`,
                            content: content,
                            branch: 'main'
                        }),
                    });
                    
                    if (!createResponse.ok) {
                        const errorData = await createResponse.json();
                        throw new Error(errorData.message || 'Failed to create new dataset on GitHub');
                    }
                    
                    setSaveMessage(`✅ Successfully created new dataset "${datasetName}" on GitHub! It will be available in a few minutes.`);
                    
                    // Store the new dataset in session storage so it appears in the list
                    const newDataset = {
                        id: `github_${safeName}`,
                        name: datasetName,
                        description: `Dataset saved to GitHub with ${editableData.length - 1} functions`,
                        countries: getCountryColumns().map(col => col.header),
                        functions: editableData.length - 1,
                        data: editableData,
                        uploadDate: new Date().toISOString(),
                        isBuiltIn: false,
                        githubUrl: `https://github.com/serenaplin-jpg/sheet-2-mindmap/blob/main/${filePath}`
                    };
                    
                    // Add to session storage
                    const sessionDatasets = JSON.parse(localStorage.getItem('session_datasets') || '[]');
                    sessionDatasets.push(newDataset);
                    localStorage.setItem('session_datasets', JSON.stringify(sessionDatasets));
                    
                    // Update the current savedDatasets state
                    setSavedDatasets(prev => [...prev, newDataset]);
                    
                    // Note: The new dataset is now saved to GitHub and appears in your list
                    

                    
                } catch (err) {
                    setError(`Failed to create new dataset on GitHub: ${err.message}`);
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handleTokenSave = (token) => {
                setGithubToken(token);
                localStorage.setItem('github_token', token);
            };
            
            const clearToken = () => {
                setGithubToken('');
                localStorage.removeItem('github_token');
            };
            
            const generateMindmap = () => {
                try {
                    const result = transformToMindmapFormat(editableData);
                    setMindmapData(result.data);
                    setCountries(result.countries);
                    setSelectedCountries([result.countries[0] || '', result.countries[1] || '']);
                                                navigateTo('mindmap');
                } catch (err) {
                    setError(err.message || 'Failed to generate mindmap');
                }
            };
            
            const handleDrop = useCallback((e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            }, []);
            
            const handleDragOver = useCallback((e) => {
                e.preventDefault();
            }, []);
            
            const handleSearch = () => {
                if (!searchTerm.trim()) return;
                
                // Check if search term exists in data
                let found = false;
                if (mindmapData) {
                    const checkNode = (node) => {
                        if (node.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            found = true;
                            return;
                        }
                        if (node.children) {
                            node.children.forEach(checkNode);
                        }
                    };
                    checkNode(mindmapData);
                }
                
                if (!found) {
                    setSearchShake(true);
                    setTimeout(() => setSearchShake(false), 500);
                }
            };
            
            const getAllFunctionNames = (node, names = []) => {
                if (node.availability) {
                    names.push(node.name);
                }
                if (node.children) {
                    node.children.forEach(child => getAllFunctionNames(child, names));
                }
                return names;
            };
            
            const functionNames = mindmapData ? getAllFunctionNames(mindmapData) : [];
            
            const updateCell = (rowIndex, colIndex, value) => {
                const newData = [...editableData];
                if (!newData[rowIndex]) {
                    newData[rowIndex] = [];
                }
                newData[rowIndex][colIndex] = value;
                setEditableData(newData);
            };
            
            // Detect which columns are country columns (contain availability data)
            const getCountryColumns = () => {
                if (!editableData || editableData.length < 2) return [];
                
                const headers = editableData[0];
                if (!headers) return [];
                
                const excludePatterns = ['name', 'category', '大項', '細項', 'sub-item', 'platform', '平台', '功能名稱'];
                
                return headers
                    .map((header, index) => ({ header: header?.toString() || `Column${index}`, index }))
                    .filter(col => {
                        const headerLower = col.header.toLowerCase();
                        const isExcluded = excludePatterns.some(pattern => 
                            headerLower.includes(pattern.toLowerCase()) || 
                            col.header.includes(pattern)
                        );
                        return !isExcluded && col.header.trim() !== '';
                    });
            };
            
            const countryColumns = getCountryColumns();
            
            const toggleAvailability = (rowIndex, colIndex) => {
                const currentValue = editableData[rowIndex][colIndex];
                const newValue = (currentValue === '√' || currentValue === 'V' || currentValue === 'v') ? '×' : '√';
                updateCell(rowIndex, colIndex, newValue);
            };
            
            const isCountryColumn = (colIndex) => {
                return countryColumns.some(col => col.index === colIndex);
            };
            
            const addRow = () => {
                const newData = [...editableData];
                const newRow = new Array(editableData[0]?.length || 10).fill('');
                
                // Set default values for country columns
                countryColumns.forEach(col => {
                    if (newRow[col.index] !== undefined) {
                        newRow[col.index] = '×'; // Default to not available
                    }
                });
                
                newData.push(newRow);
                setEditableData(newData);
            };
            
            const deleteRow = (rowIndex) => {
                if (rowIndex === 0) return; // Don't delete header
                const newData = editableData.filter((_, index) => index !== rowIndex);
                setEditableData(newData);
            };
            
            // Home View
            if (currentView === 'home') {
                const allDatasets = [...BUILTIN_DATASETS, ...savedDatasets];
                
                return (
                    <div className="w-full h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center">
                        <div className="max-w-4xl w-full p-6">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-4">
                                    🧠 Excel to Mindmap Converter
                                </h1>
                                <p className="text-lg text-gray-600 dark:text-gray-400 mb-2">
                                    Transform your Excel data into beautiful, interactive mindmaps
                                </p>
                                <p className="text-sm text-gray-500 dark:text-gray-500">
                                    Free • No signup required • Works offline
                                </p>
                            </div>
                            
                            <div className="grid md:grid-cols-2 gap-6">
                                {/* Upload Section */}
                                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                                        📁 Upload New Excel File
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <button
                                            onClick={() => navigateTo('upload')}
                                            className="w-full p-4 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                                        >
                                            <div className="text-center">
                                                <svg className="mx-auto h-12 w-12 text-blue-500 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                                </svg>
                                                <p className="text-sm font-medium text-blue-600 dark:text-blue-400">Click to upload Excel file</p>
                                                <p className="text-xs text-gray-500 mt-1">Supports .xlsx and .xls files</p>
                                            </div>
                                        </button>
                                        
                                        <div className="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                            <p>✓ Your data stays private - everything runs in your browser</p>
                                            <p>✓ Option to save datasets for future use</p>
                                            <p>✓ Supports multiple languages and Unicode</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Saved Datasets */}
                                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold text-gray-900 dark:text-white">
                                            💾 Saved Datasets
                                        </h2>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={async () => {
                                                    console.log('Home refresh button clicked');
                                                    await loadDatasetsFromGitHub();
                                                }}
                                                disabled={isLoading}
                                                className="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50"
                                                title="Refresh datasets from GitHub"
                                            >
                                                {isLoading ? 'Refreshing...' : '🔄 Refresh'}
                                            </button>
                                            {savedDatasets.length > 0 && (
                                                <button
                                                    onClick={() => navigateTo('saved')}
                                                    className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                                                >
                                                    View All →
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3 max-h-80 overflow-y-auto">
                                        {allDatasets.slice(0, 3).map(dataset => (
                                            <div key={dataset.id} className="dataset-card border border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" 
                                                 onClick={() => loadSavedDataset(dataset)}>
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center">
                                                            <h3 className="font-medium text-gray-900 dark:text-white">{dataset.name}</h3>
                                                            {dataset.isBuiltIn && (
                                                                <span className="ml-2 px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full">
                                                                    Built-in
                                                                </span>
                                                            )}
                                                        </div>
                                                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{dataset.description}</p>
                                                        <div className="flex items-center justify-between mt-2">
                                                            <div className="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                                                <span>{dataset.functions} functions</span>
                                                                <span>{dataset.countries.length} countries</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        {allDatasets.length === 0 && (
                                            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                                <p>No saved datasets yet.</p>
                                                <p className="text-sm mt-1">Upload an Excel file and save it to GitHub to get started!</p>
                                            </div>
                                        )}
                                        
                                        {allDatasets.length > 3 && (
                                            <button
                                                onClick={() => navigateTo('saved')}
                                                className="w-full py-2 text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 border border-blue-200 dark:border-blue-700 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20"
                                            >
                                                View {allDatasets.length - 3} more datasets →
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {error && (
                                <div className="mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                                    <div className="flex items-center">
                                        <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                        {error}
                                    </div>
                                </div>
                            )}
                            
                            {/* Footer */}
                            <div className="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
                                <p>Made with ❤️ for data visualization • <a href="https://github.com/serenaplin-jpg/sheet-2-mindmap" className="text-blue-600 dark:text-blue-400 hover:underline">View on GitHub</a></p>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Upload View
            if (currentView === 'upload') {
                return (
                    <div className="w-full h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center">
                        <div className="max-w-md w-full p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                            <div className="flex items-center justify-between mb-6">
                                <h1 className="text-2xl font-bold text-gray-900 dark:text-white">
                                    📁 Upload Excel File
                                </h1>
                                <button
                                    onClick={() => navigateTo('home')}
                                    className="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200"
                                >
                                    ← Back
                                </button>
                            </div>
                            
                            <div
                                className="file-upload-area mb-4"
                                onDrop={handleDrop}
                                onDragOver={handleDragOver}
                            >
                                <input
                                    type="file"
                                    accept=".xlsx,.xls"
                                    onChange={(e) => handleFileUpload(e.target.files[0])}
                                    className="hidden"
                                    id="file-input"
                                />
                                <label htmlFor="file-input" className="cursor-pointer">
                                    <div className="text-gray-600 dark:text-gray-400">
                                        <svg className="mx-auto h-12 w-12 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                        </svg>
                                        <p className="text-sm font-medium">Drop Excel file here or click to browse</p>
                                        <p className="text-xs mt-1">Supports .xlsx and .xls files</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div className="text-xs text-gray-500 dark:text-gray-400">
                                <p>✓ Your data stays private - everything runs in your browser</p>
                                <p>✓ Option to save for future use</p>
                                <p>✓ Supports multiple languages</p>
                            </div>
                            
                            {isLoading && (
                                <div className="text-center py-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                    <p className="text-sm mt-2">Processing Excel file...</p>
                                </div>
                            )}
                            
                            {error && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded mb-4">
                                    {error}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            
            // Saved Datasets View
            if (currentView === 'saved') {
                const allDatasets = [...BUILTIN_DATASETS, ...savedDatasets];
                
                return (
                    <div className="w-full h-screen bg-gray-100 dark:bg-gray-900">
                        <div className="max-w-6xl mx-auto p-6">
                            <div className="flex items-center justify-between mb-8">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                                        💾 Saved Datasets
                                    </h1>
                                    <p className="text-gray-600 dark:text-gray-400">
                                        Manage your saved datasets and built-in templates
                                    </p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={async () => {
                                            console.log('Saved page refresh button clicked');
                                            await loadDatasetsFromGitHub();
                                        }}
                                        disabled={isLoading}
                                        className="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50"
                                        title="Refresh datasets from GitHub"
                                    >
                                        {isLoading ? 'Refreshing...' : '🔄 Refresh from GitHub'}
                                    </button>
                                    <button
                                        onClick={() => navigateTo('home')}
                                        className="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200"
                                    >
                                        ← Back to Home
                                    </button>
                                </div>
                            </div>
                            
                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {allDatasets.map(dataset => (
                                    <div key={dataset.id} className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                        <div className="flex items-start justify-between mb-4">
                                            <div className="flex-1">
                                                <div className="flex items-center">
                                                    <h3 className="font-semibold text-gray-900 dark:text-white">{dataset.name}</h3>
                                                    {dataset.isBuiltIn && (
                                                        <span className="ml-2 px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full">
                                                            Built-in
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{dataset.description}</p>
                                            </div>
                                            {!dataset.isBuiltIn && (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        if (confirm(`Delete "${dataset.name}"?`)) {
                                                            // Dataset deletion removed - datasets are now GitHub-only
                                                        }
                                                    }}
                                                    className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ml-2"
                                                    title="Delete dataset"
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                        <path fillRule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                    </svg>
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
                                                <span>{dataset.functions} functions</span>
                                                <span>{dataset.countries.length} countries</span>
                                            </div>
                                            
                                            {!dataset.isBuiltIn && dataset.uploadDate && (
                                                <p className="text-xs text-gray-400 dark:text-gray-500">
                                                    Uploaded: {new Date(dataset.uploadDate).toLocaleDateString()}
                                                </p>
                                            )}
                                            
                                            <button
                                                onClick={() => loadSavedDataset(dataset)}
                                                className="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                            >
                                                Open Dataset →
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                
                                {allDatasets.length === 0 && (
                                    <div className="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">
                                        <p className="text-lg mb-2">No datasets saved yet</p>
                                        <p>Upload an Excel file and save it to GitHub to get started!</p>
                                        <p className="text-sm mt-2 text-gray-400">Datasets will appear here after you save them to GitHub</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Table View
            if (currentView === 'table') {
                // Add safety check for editableData
                if (!editableData || !editableData[0]) {
                    return (
                        <div className="w-full h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center">
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="text-gray-600 dark:text-gray-400">Loading data...</p>
                                <button 
                                    onClick={() => navigateTo('home')} 
                                    className="mt-4 px-4 py-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                                >
                                    ← Back to Home
                                </button>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div className="w-full h-screen bg-gray-100 dark:bg-gray-900 flex flex-col">
                        {/* Header */}
                        <div className="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 p-4">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900 dark:text-white">
                                        ✏️ Edit Your Data
                                    </h1>
                                    {currentDatasetId && (
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                            {currentDatasetId.startsWith('github_') 
                                                ? `GitHub Dataset: ${currentDatasetId.replace('github_', '').replace(/-/g, ' ')}`
                                                : currentDatasetId.startsWith('uploaded_')
                                                ? 'Uploaded Dataset (not saved to GitHub)'
                                                : currentDatasetId.startsWith('temp_')
                                                ? 'Temporary Dataset (not saved)'
                                                : 'Current Dataset'
                                            }
                                        </p>
                                    )}
                                </div>
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={() => navigateTo('home')}
                                        className="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-sm"
                                    >
                                        ← Back to Home
                                    </button>
                                    <button
                                        onClick={addRow}
                                        className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"
                                    >
                                        + Add Row
                                    </button>
                                    <button
                                        onClick={generateMindmap}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium"
                                    >
                                        Generate Mindmap →
                                    </button>
                                </div>
                            </div>
                            
                            {/* GitHub Save Section - Only show for valid datasets */}
                            {(currentDatasetId && currentDatasetId !== 'temp_' && !currentDatasetId.startsWith('temp_')) && (
                                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" className="mr-2 text-gray-600 dark:text-gray-400" viewBox="0 0 16 16">
                                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                                            </svg>
                                            <h3 className="font-medium text-gray-900 dark:text-white">Save to GitHub</h3>
                                        </div>
                                        {githubToken && (
                                            <button
                                                onClick={clearToken}
                                                className="text-xs text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                                            >
                                                Clear Token
                                            </button>
                                        )}
                                    </div>
                                    
                                    {!githubToken ? (
                                        <div className="space-y-3">
                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                {currentDatasetId.startsWith('uploaded_') || currentDatasetId.startsWith('temp_') 
                                                    ? 'To save your uploaded dataset to GitHub, you need a Personal Access Token.'
                                                    : 'To save changes back to GitHub, you need a Personal Access Token.'
                                                }
                                            </p>
                                            <div className="flex gap-2">
                                                <input
                                                    type="password"
                                                    placeholder="GitHub Personal Access Token"
                                                    className="flex-1 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter') {
                                                            handleTokenSave(e.target.value);
                                                        }
                                                    }}
                                                />
                                                <button
                                                    onClick={(e) => {
                                                        const input = e.target.previousElementSibling;
                                                        if (input.value.trim()) {
                                                            handleTokenSave(input.value.trim());
                                                        }
                                                    }}
                                                    className="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 text-sm"
                                                >
                                                    Save Token
                                                </button>
                                            </div>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">
                                                <a href="https://github.com/settings/tokens" target="_blank" className="text-blue-600 dark:text-blue-400 hover:underline">
                                                    Create a token here
                                                </a> with "repo" permissions. Token is stored locally and never shared.
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-3">
                                            <span className="text-sm text-green-600 dark:text-green-400">✓ Token configured</span>
                                            {(currentDatasetId.startsWith('github_')) ? (
                                                <button
                                                    onClick={saveToGitHub}
                                                    disabled={isSaving}
                                                    className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                                                >
                                                    {isSaving ? (
                                                        <>
                                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                            </svg>
                                                            Updating...
                                                        </>
                                                    ) : (
                                                        <>
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="mr-2" viewBox="0 0 16 16">
                                                                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                                                            </svg>
                                                            Update on GitHub
                                                        </>
                                                    )}
                                                </button>
                                            ) : (
                                                <span className="text-sm text-blue-600 dark:text-blue-400">
                                                    ℹ️ Use "Save as New Dataset" below to save uploaded data
                                                </span>
                                            )}
                                        </div>
                                    )}
                                    
                                    {saveMessage && (
                                        <div className="mt-3 p-3 bg-green-100 border border-green-400 text-green-700 rounded-md text-sm">
                                            {saveMessage}
                                        </div>
                                    )}
                                    
                                    {/* Save as New Dataset Section - Always visible when token is available */}
                                    {githubToken && (
                                        <div className="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                            <h4 className="font-medium text-gray-900 dark:text-white mb-2">
                                                {currentDatasetId.startsWith('uploaded_') || currentDatasetId.startsWith('temp_') 
                                                    ? 'Save Uploaded Dataset to GitHub' 
                                                    : 'Save as New Dataset'
                                                }
                                            </h4>
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    placeholder="Enter dataset name"
                                                    value={customDatasetName}
                                                    onChange={(e) => setCustomDatasetName(e.target.value)}
                                                    className="flex-1 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter' && customDatasetName.trim()) {
                                                            saveNewDatasetToGitHub(customDatasetName.trim());
                                                        }
                                                    }}
                                                />
                                                <button
                                                    onClick={() => saveNewDatasetToGitHub(customDatasetName.trim())}
                                                    disabled={isSaving || !customDatasetName.trim()}
                                                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    {isSaving ? 'Saving...' : 'Save New'}
                                                </button>
                                            </div>
                                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                This will create a new JSON file in your GitHub repository.
                                            </p>
                                        </div>
                                    )}
                                    
                                    {/* Refresh Data Button - Only for GitHub datasets */}
                                    {currentDatasetId.startsWith('github_') && (
                                        <div className="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                            <button
                                                onClick={async () => {
                                                    console.log('Refresh button clicked');
                                                    setIsLoading(true);
                                                    setError('');
                                                    
                                                    try {
                                                        // First reload all datasets from GitHub
                                                        await loadDatasetsFromGitHub();
                                                        
                                                        // Then find and reload the current dataset
                                                        const refreshedDataset = savedDatasets.find(d => d.id === currentDatasetId);
                                                        if (refreshedDataset) {
                                                            console.log('Reloading current dataset:', refreshedDataset.name);
                                                            await loadSavedDataset(refreshedDataset);
                                                        } else {
                                                            setError('Cannot refresh: dataset not found after reload.');
                                                        }
                                                    } catch (err) {
                                                        console.error('Refresh error:', err);
                                                        setError(`Refresh failed: ${err.message}`);
                                                    } finally {
                                                        setIsLoading(false);
                                                    }
                                                }}
                                                disabled={isLoading}
                                                className="flex items-center text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 disabled:opacity-50"
                                            >
                                                {isLoading ? (
                                                    <>
                                                        <svg className="animate-spin mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        Refreshing...
                                                    </>
                                                ) : (
                                                    <>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="mr-2" viewBox="0 0 16 16">
                                                            <path fillRule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                                        </svg>
                                                        Refresh Data from GitHub
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {/* Table Container */}
                        <div className="flex-1 overflow-auto p-4">
                            <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead className="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th className="w-12 px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    #
                                                </th>
                                                {editableData[0]?.map((header, colIndex) => (
                                                    <th key={colIndex} className="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider min-w-32">
                                                        <input
                                                            type="text"
                                                            value={header || ''}
                                                            onChange={(e) => updateCell(0, colIndex, e.target.value)}
                                                            className="w-full bg-transparent border-none focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-2 py-1 text-gray-900 dark:text-white font-medium"
                                                        />
                                                    </th>
                                                ))}
                                                <th className="w-12 px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            {editableData.slice(1).map((row, rowIndex) => (
                                                <tr key={rowIndex + 1} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                    <td className="px-2 py-3 text-sm text-gray-500 dark:text-gray-400">
                                                        {rowIndex + 1}
                                                    </td>
                                                    {editableData[0]?.map((_, colIndex) => (
                                                        <td key={colIndex} className="px-4 py-3">
                                                            {isCountryColumn(colIndex) ? (
                                                                <div className="flex items-center justify-center">
                                                                    <button
                                                                        onClick={() => toggleAvailability(rowIndex + 1, colIndex)}
                                                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                                                                            (row[colIndex] === '√' || row[colIndex] === 'V' || row[colIndex] === 'v')
                                                                                ? 'bg-green-600' 
                                                                                : 'bg-gray-300 dark:bg-gray-600'
                                                                        }`}
                                                                    >
                                                                        <span className="sr-only">Toggle availability</span>
                                                                        <span
                                                                            className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                                                (row[colIndex] === '√' || row[colIndex] === 'V' || row[colIndex] === 'v')
                                                                                    ? 'translate-x-6' 
                                                                                    : 'translate-x-1'
                                                                            }`}
                                                                        />
                                                                    </button>
                                                                    <span className="ml-2 text-xs text-gray-500 dark:text-gray-400">
                                                                        {(row[colIndex] === '√' || row[colIndex] === 'V' || row[colIndex] === 'v') ? '√' : '×'}
                                                                    </span>
                                                                </div>
                                                            ) : (
                                                                <input
                                                                    type="text"
                                                                    value={row[colIndex] || ''}
                                                                    onChange={(e) => updateCell(rowIndex + 1, colIndex, e.target.value)}
                                                                    className="w-full bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                />
                                                            )}
                                                        </td>
                                                    ))}
                                                    <td className="px-2 py-3">
                                                        <button
                                                            onClick={() => deleteRow(rowIndex + 1)}
                                                            className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                                                            title="Delete row"
                                                        >
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                                <path fillRule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                            </svg>
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        {error && (
                            <div className="p-4">
                                <div className="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded">
                                    {error}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // Mindmap View
            if (currentView === 'mindmap') {
                // Add safety check for mindmapData
                if (!mindmapData || !countries.length) {
                    return (
                        <div className="w-full h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center">
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="text-gray-600 dark:text-gray-400">Generating mindmap...</p>
                                <button 
                                    onClick={() => navigateTo('home')} 
                                    className="mt-4 px-4 py-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                                >
                                    ← Back to Home
                                </button>
                            </div>
                        </div>
                    );
                }
            }
            
            return (
                <div className="relative w-full h-screen bg-gray-100 dark:bg-gray-900">
                    {/* Control Panel */}
                    <div className="absolute top-0 left-0 p-4 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-br-2xl shadow-lg z-10 max-w-sm">
                        <div className="flex items-center justify-between mb-3">
                            <h1 className="text-xl font-bold text-gray-900 dark:text-white">
                                🧠 Interactive Mindmap
                            </h1>
                            <button
                                onClick={() => navigateTo('table')}
                                className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                                title="Back to Table"
                            >
                                ← Edit Data
                            </button>
                        </div>
                        
                        <>
                            {/* Country Comparison */}
                            <div className="flex flex-wrap items-center gap-2 mb-3">
                                <select
                                    value={selectedCountries[0]}
                                    onChange={(e) => setSelectedCountries([e.target.value, selectedCountries[1]])}
                                    className="w-28 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {countries.map(country => (
                                        <option key={country} value={country}>{country}</option>
                                    ))}
                                </select>
                                <span className="text-gray-500 dark:text-gray-400">vs</span>
                                <select
                                    value={selectedCountries[1]}
                                    onChange={(e) => setSelectedCountries([selectedCountries[0], e.target.value])}
                                    className="w-28 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {countries.map(country => (
                                        <option key={country} value={country}>{country}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* Search */}
                            <div className="relative mb-3">
                                <input
                                    type="text"
                                    list="searchSuggestions"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                                    className={`w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md pl-3 pr-10 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${searchShake ? 'shake' : ''}`}
                                    placeholder="Search functions..."
                                />
                                <button
                                    onClick={handleSearch}
                                    className="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                    </svg>
                                </button>
                                <datalist id="searchSuggestions">
                                    {functionNames.map(name => (
                                        <option key={name} value={name} />
                                    ))}
                                </datalist>
                            </div>
                            
                            {/* Controls */}
                            <div className="flex items-center gap-2 mb-3">
                                <button
                                    onClick={() => mindmapRef.current?.expandAll()}
                                    className="px-3 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 text-xs"
                                >
                                    Expand All
                                </button>
                                <button
                                    onClick={() => mindmapRef.current?.collapseAll()}
                                    className="px-3 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 text-xs"
                                >
                                    Collapse All
                                </button>
                                <button
                                    onClick={() => mindmapRef.current?.centerView()}
                                    className="p-1.5 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500"
                                    title="Center View"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 4.5a.5.5 0 0 1 .5.5v2h2a.5.5 0 0 1 0 1h-2v2a.5.5 0 0 1-1 0v-2h-2a.5.5 0 0 1 0-1h2v-2a.5.5 0 0 1 .5-.5z"/>
                                    </svg>
                                </button>
                            </div>
                            
                            {/* Legend and Stats */}
                            <div className="grid grid-cols-2 gap-x-4 text-xs">
                                <div className="space-y-1">
                                    <div className="flex items-center">
                                        <div className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: '#4ade80'}}></div>
                                        <span>Both Available</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: '#60a5fa'}}></div>
                                        <span>Only {selectedCountries[0]}</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-3 h-3 rounded-full mr-2" style={{backgroundColor: '#fb923c'}}></div>
                                        <span>Only {selectedCountries[1]}</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-3 h-3 rounded-full mr-2 border border-gray-400" style={{backgroundColor: '#e5e7eb'}}></div>
                                        <span>Neither</span>
                                    </div>
                                </div>
                                <div className="space-y-1 border-l border-gray-200 dark:border-gray-700 pl-4">
                                    <h3 className="font-semibold text-gray-800 dark:text-gray-100 mb-1">Statistics</h3>
                                    <div>Total: <span className="font-bold">{stats.total}</span></div>
                                    <div>{stats.countryA}: <span className="font-bold">{stats.countA}</span></div>
                                    <div>{stats.countryB}: <span className="font-bold">{stats.countB}</span></div>
                                </div>
                            </div>
                        </>
                    </div>
                    
                    {/* Mindmap Visualization */}
                    {mindmapData && (
                        <D3Mindmap
                            ref={mindmapRef}
                            data={mindmapData}
                            countries={countries}
                            selectedCountries={selectedCountries}
                            searchTerm={searchTerm}
                            onStatsUpdate={setStats}
                        />
                    )}
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>